# Corporate-logistics-service
Corporate logistics service — это  системf автоматизации корпоративной логистической службы.
Сервис реализуйте бизнес-логику процесса  авторизации и аутентификации, оплаты, комплектации и доставки заказов:

## Инфраструктуру проекта можно представить в виде схемы:

![image](https://github.com/OksanaBuivarenko/Corporate-logistics-service/assets/144807983/601d0936-5dbe-407d-8481-49427cf63c9b)

Каждый из сервисов имеет REST API для получения команд извне, таких как создание нового заказа, пополнение счёта клиента или поступление нового товара на склад.

● При обработке заказа взаимодействие сервисов между собой происходит асинхронно, так как, например, комплектация или доставка заказа могут занимать неопределённо длительное время.

● Для реализации асинхронного взаимодействия используйте брокер сообщений Apache Kafka.

● Каждый сервис имеет собственную БД. В инфраструктуре проекта базы данных находятся на одном сервере PostgreSQL, но спроектированы так, чтобы их можно разместить на разных серверах. 

## Алгоритм обработки заказа

При обработке заказ перемещается между сервисами, меняя статус.
В приложении используются следующие статусы заказа:

● registered — сразу после поступления в систему доставки;

● paid — после успешной оплаты заказа;

● payment_failed — если оплата не прошла;

● invented — если комплектация заказа прошла успешно;

● inventment_failed — если на складе не нашлось нужных товаров;

● delivered — если заказ был успешно доставлен;

● delivery_failed — если при доставке возникли проблемы.

● unexpected_failure — если произошла непредвиденная ошибка при обработке заказа.

При изменении статуса информация об этом поступает в сервис заказов. В его API для этого есть конечная точка PATCH /api/order/{orderId}. Это единственное взаимодействие сервисов системы через REST API. Все остальные взаимодействия при обработке заказа происходит асинхронно. 

1. После регистрации заказа через обращение к REST API сервиса заказов (Order Service) сервис заказов помещает сообщение о новом заказе в очередь сервиса оплаты. Также сервис хранит текущий статус заказа и историю изменений статуса.
2. Сервис оплаты (Payment Service) получает сообщение и проверяет, достаточно ли средств у клиента из заказа для его оплаты.   
Если средств недостаточно или у сервиса нет информации о клиенте,  распределённая транзакция откатывается в соответствии с паттерном SAGA.
Если оплата прошла успешно, остаток на счёте корректируется и в очередь сервиса склада (Inventory Service) отправляется сообщение. 

3. Cервис склада (Inventory Service) получает сообщение от сервиса оплаты и проверяет, есть ли на складе все товары, упомянутые в заказе. 
Если какой-то из товаров не найден, транзакция откатывается в соответствии с паттерном SAGA. Сумма оплаты заказа возвращается на счёт.
Если все товары найдены в нужном количестве, корректируется количество товаров на складе и отправляется сообщение в очередь сервиса доставки. 

4. Сервис доставки (Delivery Service)  имеет схематичную бизнес-логику. После поступления заказа на этот сервис он отправляет сообщение сервису заказов (Order Service) о том, завершилась ли доставка заказа успешно
или возникли проблемы. Сообщение об успешной доставке отправляеся для 85% заказов, а об ошибке — для 15% заказов.



## Начало работы

1. Установите на свой компьютер [JDK](https://www.oracle.com/cis/java/technologies/downloads/) и среду разработки [IntelliJ IDEA](https://www.jetbrains.com/ru-ru/idea/download/?section=windows), если они ещё не установлены.
   
2. Загрузите проект-заготовку из Git-репозитория.

3. Запустите базу данных Postgres и Apache Kafka в [Docker](https://www.docker.com/products/docker-desktop/), выполнив команду в терминале docker compose up.

4. Загрузите starter  с общими зависимостями в локальный репозиторий при помощи команды mvn install.

5. Запустите сервис внешних настроек и сервисов обнаружения - Discovery.

6. Запустите Authentication, Order Service, Payment Service, Inventory Service, Delivery Service.

7. Запустите API шлюз - Gateway.

После запуска всех сервисов документацию по API можно увидеть в [Swagger](http://localhost:8765/webjars/swagger-ui/index.html).  
Для тестирования REST-API можно использовать [Postman](https://www.postman.com/downloads/).
